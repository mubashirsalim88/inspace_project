<!-- app/dashboard/templates/user_dashboard.html -->
{% extends "base.html" %}
{% block title %}Dashboard - IN-SPACe{% endblock %}
{% block content %}
<div class="p-6">
    <h2 class="text-2xl font-bold text-gray-800 mb-4 animate__animated animate__fadeInDown">Welcome to IN-SPACe Portal</h2>
    <p class="text-gray-600 mb-4">Manage space activities and applications seamlessly.</p>

    <!-- Navigation Tabs for Modules -->
    <div class="border-b border-gray-200 mb-6">
        <nav class="-mb-px flex space-x-8">
            {% for module in ['module_1', 'module_2'] %}
            <button class="tab-link px-4 py-2 text-gray-600 hover:text-blue-600 border-b-2 border-transparent focus:outline-none" data-tab="{{ module }}">{{ module|replace('_', ' ')|title }}</button>
            {% endfor %}
        </nav>
    </div>

    <!-- Module Sections -->
    {% for module in ['module_1', 'module_2'] %}
    <div id="{{ module }}" class="tab-content {% if module != 'module_1' %}hidden{% endif %}">
        <!-- Create New Application Button -->
        <div class="text-center mb-6">
            <a href="#" id="start-application-link-{{ module }}" class="py-3 px-6 rounded-lg text-white bg-gradient-to-r from-[#0d98ba] to-[#0a7a9a] hover:scale-105 transition-all duration-300 shadow-lg" data-module="{{ module }}">
                Create New {{ module|replace('_', ' ')|title }} Application
            </a>
        </div>

        <!-- Applications List -->
        <div class="bg-white shadow-lg rounded-lg p-6">
            <h3 class="text-xl font-semibold mb-4 text-gray-800">Submitted {{ module|replace('_', ' ')|title }} Applications</h3>
            {% if module_apps[module] %}
            <ul class="space-y-4">
                {% for application in module_apps[module] %}
                <li class="p-4 bg-gray-50 rounded-lg shadow flex justify-between items-center hover:bg-gray-100 transition-all duration-300">
                    <div>
                        <h4 class="text-lg font-medium text-gray-900">{{ application.user.name }}</h4>
                        <p class="text-sm text-gray-600">{{ module|replace('_', ' ')|title }}</p>
                        <p class="text-sm text-gray-500">Submitted on {{ application.created_at.strftime('%B %d, %Y') if application.created_at else 'Not Submitted Yet' }}</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        {% if application.status == 'Pending' %}
                            <span class="bg-yellow-100 text-yellow-700 text-xs font-medium px-3 py-1 rounded-lg">Pending</span>
                        {% elif application.status == 'Approved' %}
                            <span class="bg-green-100 text-green-700 text-xs font-medium px-3 py-1 rounded-lg">Approved</span>
                        {% elif application.status == 'Submitted' %}
                            <span class="bg-blue-100 text-blue-700 text-xs font-medium px-3 py-1 rounded-lg">Submitted</span>
                        {% else %}
                            <span class="bg-red-100 text-red-700 text-xs font-medium px-3 py-1 rounded-lg">Rejected</span>
                        {% endif %}
                        {% if application.status == 'Pending' %}
                        <a href="{{ url_for(module + '.fill_step', step='applicant_identity', application_id=application.id) }}" class="text-blue-600 hover:underline text-sm font-semibold">
                            View / Edit
                        </a>
                        {% else %}
                        <span class="text-gray-500 text-sm font-semibold cursor-not-allowed" title="Editing is disabled because the application is {{ application.status }}">
                            View / Edit (Disabled)
                        </span>
                        {% endif %}
                    </div>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="text-gray-500 text-center">No {{ module|replace('_', ' ')|title }} applications found.</p>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Tab Switching
        const tabLinks = document.querySelectorAll(".tab-link");
        const tabContents = document.querySelectorAll(".tab-content");

        tabLinks.forEach(button => {
            button.addEventListener("click", () => {
                const tabId = button.getAttribute("data-tab");

                tabLinks.forEach(btn => {
                    btn.classList.remove("text-blue-600", "border-blue-600");
                    btn.classList.add("border-transparent");
                });
                tabContents.forEach(content => content.classList.add("hidden"));

                button.classList.add("text-blue-600", "border-blue-600");
                document.getElementById(tabId).classList.remove("hidden");
            });
        });

        // Create New Application Buttons
        document.querySelectorAll("[id^='start-application-link-']").forEach(link => {
            link.addEventListener("click", function(event) {
                event.preventDefault();
                const module = this.getAttribute("data-module");
                fetch(`{{ url_for('dashboard.start_application') }}?module=${module}`, {
                    method: "GET",
                    headers: { "Content-Type": "application/json" }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire({
                            title: "Success!",
                            text: `New ${module.replace('_', ' ')} application started successfully!`,
                            icon: "success",
                            confirmButtonColor: "#3085d6",
                            confirmButtonText: "Proceed"
                        }).then(() => {
                            window.location.href = `{{ url_for('module_1.fill_step', step='applicant_identity') }}?application_id=${data.application_id}`;
                        });
                    } else {
                        Swal.fire({
                            title: "Warning!",
                            text: `You have an incomplete ${module.replace('_', ' ')} application. Please complete it first.`,
                            icon: "warning",
                            confirmButtonColor: "#d33",
                            confirmButtonText: "Go to Forms"
                        }).then(() => {
                            window.location.href = `{{ url_for('module_1.fill_step', step='applicant_identity') }}`;
                        });
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    Swal.fire({
                        title: "Error!",
                        text: "Something went wrong. Please try again later.",
                        icon: "error",
                        confirmButtonColor: "#d33",
                        confirmButtonText: "Close"
                    });
                });
            });
        });
    });
</script>
{% endblock %}