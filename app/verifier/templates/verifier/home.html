{% extends "base.html" %}
{% block title %}Verifier Dashboard - IN-SPACe{% endblock %}
{% block content %}
<div class="min-h-screen bg-purple-50 p-8">
    <h2 class="text-4xl font-extrabold text-purple-900 mb-4 animate__animated animate__fadeInDown">Verifier Dashboard</h2>
    <p class="text-gray-700 mb-8">Review and manage assigned applications across modules.</p>

    <!-- Recent Actions Section -->
    <div class="mb-12">
        <h3 class="text-2xl font-semibold text-purple-800 mb-4">Recent Actions (Last 7 Days)</h3>
        {% set recent_apps = [] %}
        {% for module in module_apps %}
            {% for app in module_apps[module] %}
                {% if (datetime.now() - app.updated_at).days <= 7 %}
                    {% set ns = namespace(found=false) %}
                    {% for ra in recent_apps %}
                        {% if ra.app.id == app.id %}
                            {% set ns.found = true %}
                        {% endif %}
                    {% endfor %}
                    {% if not ns.found %}
                        {% set _ = recent_apps.append({'module': module, 'app': app}) %}
                    {% endif %}
                {% endif %}
            {% endfor %}
        {% endfor %}
        {% if recent_apps %}
        <div class="bg-white shadow-xl rounded-lg border border-purple-200 overflow-x-auto">
            <table class="w-full text-left">
                <thead>
                    <tr class="bg-purple-100 text-purple-800">
                        <th class="p-4 font-semibold">Module</th>
                        <th class="p-4 font-semibold">ID</th>
                        <th class="p-4 font-semibold">Applicant</th>
                        <th class="p-4 font-semibold">Status</th>
                        <th class="p-4 font-semibold">Last Updated</th>
                        <th class="p-4 font-semibold">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in recent_apps|sort(attribute='app.updated_at', reverse=True) %}
                    {% set app = item.app %}
                    {% set is_actionable = app.status in ['Under Review', 'Pending Secondary Approval'] and (app.status == 'Under Review' and role == 'Primary Verifier' or app.status == 'Pending Secondary Approval' and role == 'Secondary Verifier') %}
                    <tr class="border-b {% if is_actionable %}bg-yellow-50{% else %}hover:bg-gray-50{% endif %}">
                        <td class="p-4">{{ item.module|replace('_', ' ')|title }}</td>
                        <td class="p-4">{{ app.id }}</td>
                        <td class="p-4">{{ app.user.username }}</td>
                        <td class="p-4">
                            <span class="{% if app.status == 'Under Review' or app.status == 'Pending Secondary Approval' %}bg-yellow-200 text-yellow-800{% elif app.status == 'Approved' %}bg-green-200 text-green-800{% elif app.status == 'Rejected' %}bg-red-200 text-red-800{% else %}bg-gray-200 text-gray-800{% endif %} text-sm font-medium px-3 py-1 rounded-lg">{{ app.status }}</span>
                            <span class="bg-purple-200 text-purple-800 text-sm font-medium px-3 py-1 rounded-lg ml-2">New</span>
                        </td>
                        <td class="p-4">{{ app.updated_at.strftime('%B %d, %Y') }}</td>
                        <td class="p-4">
                            {% if is_actionable %}
                                <a href="{{ url_for('verifier.review', application_id=app.id) }}" class="py-2 px-4 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm font-semibold">Review Now</a>
                            {% else %}
                                <span class="text-gray-500 text-sm">No Action</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-gray-500 bg-white p-4 rounded-lg shadow-lg border border-purple-200 text-center">No applications updated in the last 7 days.</p>
        {% endif %}
    </div>

    <!-- Module Sections -->
    <div class="mb-12">
        <h3 class="text-2xl font-semibold text-purple-800 mb-4">Module Details</h3>
        <div class="space-y-4">
            {% for module in fixed_modules %}
            <div class="collapsible-section bg-white shadow-lg rounded-lg border border-purple-200">
                <button class="collapsible-header w-full text-left p-4 bg-purple-100 text-purple-800 font-semibold text-lg flex justify-between items-center hover:bg-purple-200 transition-colors">
                    <div class="flex items-center">
                        {{ module|replace('_', ' ')|title }}
                        {% set actionable_count = module_apps[module]|selectattr('status', 'in', ['Under Review', 'Pending Secondary Approval'])|selectattr('status', 'equalto', 'Under Review' if role == 'Primary Verifier' else 'Pending Secondary Approval')|list|length %}
                        {% if actionable_count > 0 %}
                            <span class="ml-3 bg-yellow-200 text-yellow-800 text-sm font-medium px-3 py-1 rounded-full">{{ actionable_count }} to Review</span>
                        {% endif %}
                        {% if module in recent_actionable_modules %}
                            <span class="ml-3 w-3 h-3 bg-purple-500 rounded-full"></span>
                        {% endif %}
                    </div>
                    <svg class="w-6 h-6 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
                <div class="collapsible-content hidden p-6">
                    {% if module_apps[module] %}
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="bg-purple-100 text-purple-800">
                                    <th class="p-4 font-semibold">ID</th>
                                    <th class="p-4 font-semibold">Applicant</th>
                                    <th class="p-4 font-semibold">Status</th>
                                    <th class="p-4 font-semibold">Last Updated</th>
                                    <th class="p-4 font-semibold">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for app in module_apps[module]|sort(attribute='updated_at', reverse=True) %}
                                {% set is_new = (datetime.now() - app.updated_at).days <= 7 %}
                                {% set is_actionable = app.status in ['Under Review', 'Pending Secondary Approval'] and (app.status == 'Under Review' and role == 'Primary Verifier' or app.status == 'Pending Secondary Approval' and role == 'Secondary Verifier') %}
                                <tr class="border-b {% if is_actionable %}bg-yellow-50{% else %}hover:bg-gray-50{% endif %}">
                                    <td class="p-4">{{ app.id }}</td>
                                    <td class="p-4">{{ app.user.username }}</td>
                                    <td class="p-4">
                                        <span class="{% if app.status == 'Under Review' or app.status == 'Pending Secondary Approval' %}bg-yellow-200 text-yellow-800{% elif app.status == 'Approved' %}bg-green-200 text-green-800{% elif app.status == 'Rejected' %}bg-red-200 text-red-800{% else %}bg-gray-200 text-gray-800{% endif %} text-sm font-medium px-3 py-1 rounded-lg">{{ app.status }}</span>
                                        {% if is_new %}
                                            <span class="bg-purple-200 text-purple-800 text-sm font-medium px-3 py-1 rounded-lg ml-2">New</span>
                                        {% endif %}
                                    </td>
                                    <td class="p-4">{{ app.updated_at.strftime('%B %d, %Y') }}</td>
                                    <td class="p-4">
                                        {% if is_actionable %}
                                            <a href="{{ url_for('verifier.review', application_id=app.id) }}" class="py-2 px-4 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm font-semibold">Review Now</a>
                                        {% else %}
                                            <span class="text-gray-500 text-sm">No Action</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-gray-500 text-center py-4">No {{ module|replace('_', ' ')|title }} applications assigned.</p>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Completed Applications Section -->
    <div>
        <h3 class="text-2xl font-semibold text-purple-800 mb-4">Completed Applications</h3>
        <div class="space-y-4">
            {% for module in fixed_modules %}
            <div class="collapsible-section bg-white shadow-lg rounded-lg border border-purple-200">
                <button class="collapsible-header w-full text-left p-4 bg-purple-100 text-purple-800 font-semibold text-lg flex justify-between items-center hover:bg-purple-200 transition-colors">
                    <div class="flex items-center">
                        {{ module|replace('_', ' ')|title }} (Completed)
                        {% set completed_count = completed_module_apps[module]|length %}
                        {% if completed_count > 0 %}
                            <span class="ml-3 bg-gray-200 text-gray-800 text-sm font-medium px-3 py-1 rounded-full">{{ completed_count }} Completed</span>
                        {% endif %}
                    </div>
                    <svg class="w-6 h-6 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
                <div class="collapsible-content hidden p-6">
                    {% if completed_module_apps[module] %}
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="bg-purple-100 text-purple-800">
                                    <th class="p-4 font-semibold">ID</th>
                                    <th class="p-4 font-semibold">Applicant</th>
                                    <th class="p-4 font-semibold">Status</th>
                                    <th class="p-4 font-semibold">Last Updated</th>
                                    <th class="p-4 font-semibold">Comments</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for app in completed_module_apps[module]|sort(attribute='updated_at', reverse=True) %}
                                <tr class="border-b hover:bg-gray-50">
                                    <td class="p-4">{{ app.id }}</td>
                                    <td class="p-4">{{ app.user.username }}</td>
                                    <td class="p-4">
                                        <span class="{% if app.status == 'Approved' %}bg-green-200 text-green-800{% elif app.status == 'Rejected' %}bg-red-200 text-red-800{% endif %} text-sm font-medium px-3 py-1 rounded-lg">{{ app.status }}</span>
                                    </td>
                                    <td class="p-4">{{ app.updated_at.strftime('%B %d, %Y') }}</td>
                                    <td class="p-4">{{ app.comments or 'None' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-gray-500 text-center py-4">No completed {{ module|replace('_', ' ')|title }} applications.</p>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const collapsibleHeaders = document.querySelectorAll(".collapsible-header");
    collapsibleHeaders.forEach(header => {
        header.addEventListener("click", () => {
            const content = header.nextElementSibling;
            const icon = header.querySelector("svg");
            const isOpen = !content.classList.contains("hidden");

            // Close all other sections
            document.querySelectorAll(".collapsible-content").forEach(c => c.classList.add("hidden"));
            document.querySelectorAll(".collapsible-header svg").forEach(i => i.classList.remove("rotate-180"));

            // Toggle current section
            if (!isOpen) {
                content.classList.remove("hidden");
                icon.classList.add("rotate-180");
            }
        });
    });

    // Open the first section by default
    const firstContent = document.querySelector(".collapsible-content");
    const firstIcon = document.querySelector(".collapsible-header svg");
    if (firstContent && firstIcon) {
        firstContent.classList.remove("hidden");
        firstIcon.classList.add("rotate-180");
    }
});
</script>
{% endblock %}