{% extends "base.html" %}
{% block title %}Verifier Dashboard - IN-SPACe{% endblock %}
{% block content %}
<div class="p-8 bg-gray-100 min-h-screen">
    <h2 class="text-3xl font-bold text-gray-800 mb-6 animate__animated animate__fadeInDown">Verifier Dashboard ({{ role }})</h2>
    <p class="text-gray-600 mb-8">Review and verify assigned applications. Recent updates are listed first, followed by module details.</p>

    <!-- Recent Actions Section -->
    <div class="mb-12">
        <h3 class="text-xl font-semibold text-green-800 mb-4">Recent Actions (Last 7 Days)</h3>
        {% set recent_apps = [] %}
        {% for module in module_apps %}
            {% for app in module_apps[module] %}
                {% if (datetime.now() - app.updated_at).days <= 7 %}
                    {% set ns = namespace(found=false) %}
                    {% for ra in recent_apps %}
                        {% if ra.app.id == app.id %}
                            {% set ns.found = true %}
                        {% endif %}
                    {% endfor %}
                    {% if not ns.found %}
                        {% set _ = recent_apps.append({'module': module, 'app': app}) %}
                    {% endif %}
                {% endif %}
            {% endfor %}
        {% endfor %}
        {% if recent_apps %}
        <div class="overflow-x-auto bg-white shadow-lg rounded-lg border border-green-200">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-green-50 text-green-800">
                        <th class="p-3 font-semibold">Module</th>
                        <th class="p-3 font-semibold">ID</th>
                        <th class="p-3 font-semibold">Applicant</th>
                        <th class="p-3 font-semibold">Status</th>
                        <th class="p-3 font-semibold">Last Updated</th>
                        <th class="p-3 font-semibold">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in recent_apps|sort(attribute='app.updated_at', reverse=True) %}
                    {% set app = item.app %}
                    {% set is_actionable = (role == 'Primary Verifier' and app.status == 'Under Review') or (role == 'Secondary Verifier' and app.status == 'Pending Secondary Approval') %}
                    <tr class="border-b {% if is_actionable %}bg-yellow-50{% else %}hover:bg-gray-50{% endif %}">
                        <td class="p-3">{{ item.module|replace('_', ' ')|title }}</td>
                        <td class="p-3">{{ app.id }}</td>
                        <td class="p-3">{{ app.user.username }}</td>
                        <td class="p-3">
                            {% if app.status == 'Under Review' %}
                                <span class="bg-yellow-200 text-yellow-800 text-sm font-medium px-3 py-1 rounded-lg">Under Review</span>
                            {% elif app.status == 'Pending Secondary Approval' %}
                                <span class="bg-blue-200 text-blue-800 text-sm font-medium px-3 py-1 rounded-lg">Pending Secondary</span>
                            {% elif app.status == 'Approved' %}
                                <span class="bg-green-200 text-green-800 text-sm font-medium px-3 py-1 rounded-lg">Approved</span>
                            {% elif app.status == 'Rejected' %}
                                <span class="bg-red-200 text-red-800 text-sm font-medium px-3 py-1 rounded-lg">Rejected</span>
                            {% elif app.status == 'Pending' %}
                                <span class="bg-gray-200 text-gray-800 text-sm font-medium px-3 py-1 rounded-lg">Pending</span>
                            {% endif %}
                            <span class="bg-indigo-200 text-indigo-800 text-sm font-medium px-3 py-1 rounded-lg ml-2">New</span>
                        </td>
                        <td class="p-3">{{ app.updated_at.strftime('%B %d, %Y') }}</td>
                        <td class="p-3">
                            {% if is_actionable %}
                                <a href="{{ url_for('verifier.review', application_id=app.id) }}" class="py-1.5 px-4 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm font-semibold shadow">Review Now</a>
                            {% else %}
                                <span class="text-gray-500 text-sm">No Action</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-gray-500 bg-white p-4 rounded-lg shadow-lg border border-green-200 text-center">No applications updated in the last 7 days.</p>
        {% endif %}
    </div>

    <!-- Module Sections -->
    <div>
        <h3 class="text-xl font-semibold text-green-800 mb-4">Module Details</h3>
        <div class="space-y-4">
            {% for module in fixed_modules %}
            <div class="collapsible-section bg-white shadow-lg rounded-lg border border-green-200">
                <button class="collapsible-header w-full text-left p-4 bg-green-50 text-green-800 font-semibold text-lg flex justify-between items-center hover:bg-green-100 transition-colors duration-200">
                    <div class="flex items-center">
                        {{ module|replace('_', ' ')|title }}
                        {% set actionable_count = module_apps[module]|selectattr('status', 'in', ['Under Review'] if role == 'Primary Verifier' else ['Pending Secondary Approval'] if role == 'Secondary Verifier' else [])|list|length %}
                        {% if actionable_count > 0 %}
                            <span class="ml-3 bg-yellow-200 text-yellow-800 text-sm font-medium px-3 py-1 rounded-full">{{ actionable_count }} to Review</span>
                        {% endif %}
                        {% if module in recent_actionable_modules %}
                            <span class="ml-3 w-3 h-3 bg-green-500 rounded-full"></span>
                        {% endif %}
                    </div>
                    <svg class="w-6 h-6 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
                <div class="collapsible-content hidden p-6">
                    {% if module_apps[module] %}
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-green-50 text-green-800">
                                    <th class="p-3 font-semibold">ID</th>
                                    <th class="p-3 font-semibold">Applicant</th>
                                    <th class="p-3 font-semibold">Status</th>
                                    <th class="p-3 font-semibold">Last Updated</th>
                                    <th class="p-3 font-semibold">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for app in module_apps[module]|sort(attribute='updated_at', reverse=True) %}
                                {% set is_new = (datetime.now() - app.updated_at).days <= 7 %}
                                {% set is_actionable = (role == 'Primary Verifier' and app.status == 'Under Review') or (role == 'Secondary Verifier' and app.status == 'Pending Secondary Approval') %}
                                <tr class="border-b {% if is_actionable %}bg-yellow-50{% else %}hover:bg-gray-50{% endif %}">
                                    <td class="p-3">{{ app.id }}</td>
                                    <td class="p-3">{{ app.user.username }}</td>
                                    <td class="p-3">
                                        {% if app.status == 'Under Review' %}
                                            <span class="bg-yellow-200 text-yellow-800 text-sm font-medium px-3 py-1 rounded-lg">Under Review</span>
                                        {% elif app.status == 'Pending Secondary Approval' %}
                                            <span class="bg-blue-200 text-blue-800 text-sm font-medium px-3 py-1 rounded-lg">Pending Secondary</span>
                                        {% elif app.status == 'Approved' %}
                                            <span class="bg-green-200 text-green-800 text-sm font-medium px-3 py-1 rounded-lg">Approved</span>
                                        {% elif app.status == 'Rejected' %}
                                            <span class="bg-red-200 text-red-800 text-sm font-medium px-3 py-1 rounded-lg">Rejected</span>
                                        {% elif app.status == 'Pending' %}
                                            <span class="bg-gray-200 text-gray-800 text-sm font-medium px-3 py-1 rounded-lg">Pending</span>
                                        {% endif %}
                                        {% if is_new %}
                                            <span class="bg-indigo-200 text-indigo-800 text-sm font-medium px-3 py-1 rounded-lg ml-2">New</span>
                                        {% endif %}
                                    </td>
                                    <td class="p-3">{{ app.updated_at.strftime('%B %d, %Y') }}</td>
                                    <td class="p-3">
                                        {% if is_actionable %}
                                            <a href="{{ url_for('verifier.review', application_id=app.id) }}" class="py-1.5 px-4 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm font-semibold shadow">Review Now</a>
                                        {% else %}
                                            <span class="text-gray-500 text-sm">No Action</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-gray-500 text-center">No {{ module|replace('_', ' ')|title }} applications assigned.</p>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const collapsibleHeaders = document.querySelectorAll(".collapsible-header");
    collapsibleHeaders.forEach(header => {
        header.addEventListener("click", () => {
            const content = header.nextElementSibling;
            const icon = header.querySelector("svg");
            const isOpen = !content.classList.contains("hidden");

            // Close all other sections
            document.querySelectorAll(".collapsible-content").forEach(c => c.classList.add("hidden"));
            document.querySelectorAll(".collapsible-header svg").forEach(i => i.classList.remove("rotate-180"));

            // Toggle current section
            if (!isOpen) {
                content.classList.remove("hidden");
                icon.classList.add("rotate-180");
            }
        });
    });

    // Open the first section by default
    const firstContent = document.querySelector(".collapsible-content");
    const firstIcon = document.querySelector(".collapsible-header svg");
    if (firstContent && firstIcon) {
        firstContent.classList.remove("hidden");
        firstIcon.classList.add("rotate-180");
    }
});
</script>
{% endblock %}