{% extends "base.html" %}
{% block title %}Applicant Dashboard - IN-SPACe{% endblock %}
{% block content %}
<div class="p-6">
    <h2 class="text-2xl font-bold text-gray-800 mb-4 animate__animated animate__fadeInDown">Welcome to IN-SPACe Portal</h2>
    <p class="text-gray-600 mb-4">Manage space activities and applications seamlessly.</p>

    <!-- Navigation Tabs for Modules -->
    <div class="border-b border-gray-200 mb-6">
        <nav class="-mb-px flex flex-wrap gap-2">
            {% for module in ['module_1', 'module_2', 'module_3', 'module_4', 'module_5', 'module_6', 'module_7', 'module_8', 'module_9', 'module_10'] %}
            <button class="tab-link px-5 py-3 text-gray-600 hover:text-blue-600 hover:bg-blue-50 border-b-2 {% if module == active_module %}text-blue-600 bg-blue-100 border-blue-600 font-bold{% else %}border-transparent{% endif %} focus:outline-none transition-all duration-200 text-md" data-tab="{{ module }}">{{ MODULE_NAME_MAPPING[module] }}</button>
            {% endfor %}
        </nav>
    </div>

    <!-- Module Sections -->
    {% for module in ['module_1', 'module_2', 'module_3', 'module_4', 'module_5', 'module_6', 'module_7', 'module_8', 'module_9', 'module_10'] %}
    <div id="{{ module }}" class="tab-content {% if module != active_module %}hidden{% endif %}">
        <!-- Create New Application Button -->
        <div class="text-center mb-6">
            <a href="#" id="start-application-link-{{ module }}" class="py-3 px-6 rounded-lg text-white {% if module == 'module_1' %}bg-gradient-to-r from-blue-500 to-blue-700 hover:from-blue-600 hover:to-blue-800{% elif module == 'module_2' %}bg-gradient-to-r from-green-500 to-green-700 hover:from-green-600 hover:to-green-800{% elif module == 'module_3' %}bg-gradient-to-r from-purple-500 to-purple-700 hover:from-purple-600 hover:to-purple-800{% elif module == 'module_4' %}bg-gradient-to-r from-indigo-500 to-indigo-700 hover:from-indigo-600 hover:to-indigo-800{% elif module == 'module_5' %}bg-gradient-to-r from-pink-500 to-pink-700 hover:from-pink-600 hover:to-pink-800{% elif module == 'module_6' %}bg-gradient-to-r from-yellow-500 to-yellow-700 hover:from-yellow-600 hover:to-yellow-800{% elif module == 'module_7' %}bg-gradient-to-r from-orange-500 to-orange-700 hover:from-orange-600 hover:to-orange-800{% elif module == 'module_8' %}bg-gradient-to-r from-teal-500 to-teal-700 hover:from-teal-600 hover:to-teal-800{% elif module == 'module_9' %}bg-gradient-to-r from-cyan-500 to-cyan-700 hover:from-cyan-600 hover:to-cyan-800{% elif module == 'module_10' %}bg-gradient-to-r from-red-500 to-red-700 hover:from-red-600 hover:to-red-800{% endif %} hover:scale-105 transition-all duration-300 shadow-lg" data-module="{{ module }}">
                Create New {{ MODULE_NAME_MAPPING[module] }} Application
            </a>
        </div>

        <!-- Applications List -->
        <div class="max-h-[calc(100vh-16rem)] overflow-y-auto {% if module == 'module_1' %}bg-blue-50 border border-blue-200{% elif module == 'module_2' %}bg-green-50 border border-blue-200{% elif module == 'module_3' %}bg-purple-50 border border-purple-200{% elif module == 'module_4' %}bg-indigo-50 border border-indigo-200{% elif module == 'module_5' %}bg-pink-50 border border-pink-200{% elif module == 'module_6' %}bg-yellow-50 border border-yellow-200{% elif module == 'module_7' %}bg-orange-50 border border-orange-200{% elif module == 'module_8' %}bg-teal-50 border border-teal-200{% elif module == 'module_9' %}bg-cyan-50 border border-cyan-200{% elif module == 'module_10' %}bg-red-50 border border-red-200{% endif %} shadow-lg rounded-lg p-6 {% if module == active_module %}ring-2 ring-offset-2 ring-blue-500{% endif %}">
            <h3 class="text-xl font-semibold mb-4 {% if module == 'module_1' %}text-blue-800{% elif module == 'module_2' %}text-green-800{% elif module == 'module_3' %}text-purple-800{% elif module == 'module_4' %}text-indigo-800{% elif module == 'module_5' %}text-pink-800{% elif module == 'module_6' %}text-yellow-800{% elif module == 'module_7' %}text-orange-800{% elif module == 'module_8' %}text-teal-800{% elif module == 'module_9' %}text-cyan-800{% elif module == 'module_10' %}text-red-800{% endif %}">Submitted {{ MODULE_NAME_MAPPING[module] }} Applications</h3>
            {% if module_apps[module] %}
            <ul class="space-y-4">
                {% for application in module_apps[module] %}
                <li class="p-4 {% if module == 'module_1' %}bg-blue-100 hover:bg-blue-200{% elif module == 'module_2' %}bg-green-100 hover:bg-green-200{% elif module == 'module_3' %}bg-purple-100 hover:bg-purple-200{% elif module == 'module_4' %}bg-indigo-100 hover:bg-indigo-200{% elif module == 'module_5' %}bg-pink-100 hover:bg-pink-200{% elif module == 'module_6' %}bg-yellow-100 hover:bg-yellow-200{% elif module == 'module_7' %}bg-orange-100 hover:bg-orange-200{% elif module == 'module_8' %}bg-teal-100 hover:bg-teal-200{% elif module == 'module_9' %}bg-cyan-100 hover:bg-cyan-200{% elif module == 'module_10' %}bg-red-100 hover:bg-red-200{% endif %} rounded-lg shadow flex justify-between items-center transition-all duration-300">
                    <div>
                        <h4 class="text-lg font-medium text-gray-900">{{ application.user.name }}</h4>
                        <p class="text-sm {% if module == 'module_1' %}text-blue-600{% elif module == 'module_2' %}text-green-600{% elif module == 'module_3' %}text-purple-600{% elif module == 'module_4' %}text-indigo-600{% elif module == 'module_5' %}text-pink-600{% elif module == 'module_6' %}text-yellow-600{% elif module == 'module_7' %}text-orange-600{% elif module == 'module_8' %}text-teal-600{% elif module == 'module_9' %}text-cyan-600{% elif module == 'module_10' %}text-red-600{% endif %}">{{ MODULE_NAME_MAPPING[module] }}</p>
                        <p class="text-sm text-gray-500">Created on {{ application.created_at.strftime('%B %d, %Y') if application.created_at else 'Not Submitted Yet' }}</p>
                        {% if application.status in ['Approved', 'Rejected'] %}
                        <p class="text-sm {% if application.status == 'Approved' %}text-green-600{% else %}text-red-600{% endif %}">
                            Status: {{ application.status }} {% if application.comments %}- Comments: {{ application.comments }}{% endif %}
                        </p>
                        {% elif application.status in ['Under Review', 'Pending Secondary Approval', 'Pending Director Approval', 'Pending Primary Confirmation'] %}
                        <p class="text-sm text-yellow-600">Status: {{ application.status }}</p>
                        {% endif %}
                    </div>
                    <div class="flex items-center space-x-4">
                        {% if application.status == 'Pending' %}
                            <span class="bg-yellow-100 text-yellow-700 text-xs font-medium px-3 py-1 rounded-lg">Pending</span>
                        {% elif application.status == 'Approved' %}
                            <span class="bg-green-100 text-green-700 text-xs font-medium px-3 py-1 rounded-lg">Approved</span>
                        {% elif application.status == 'Submitted' %}
                            <span class="bg-blue-100 text-blue-700 text-xs font-medium px-3 py-1 rounded-lg">Submitted</span>
                        {% elif application.status in ['Under Review', 'Pending Secondary Approval', 'Pending Director Approval', 'Pending Primary Confirmation'] %}
                            <span class="bg-yellow-100 text-yellow-700 text-xs font-medium px-3 py-1 rounded-lg">{{ application.status }}</span>
                        {% elif application.status == 'Rejected' %}
                            <span class="bg-red-100 text-red-700 text-xs font-medium px-3 py-1 rounded-lg">Rejected</span>
                        {% else %}
                            <span class="bg-gray-100 text-gray-700 text-xs font-medium px-3 py-1 rounded-lg">{{ application.status }}</span>
                        {% endif %}
                        {% if application.status == 'Pending' %}
                        <a href="{% if module == 'module_1' %}{{ url_for('module_1.fill_step', step='applicant_identity', application_id=application.id) }}{% elif module == 'module_2' %}{{ url_for('module_2.fill_step', step='satellite_overview', application_id=application.id) }}{% elif module == 'module_3' %}{{ url_for('module_3.fill_step', step='renewal_and_provisioning', application_id=application.id) }}{% elif module == 'module_4' %}{{ url_for('module_4.fill_step', step='extension_and_orbit', application_id=application.id) }}{% elif module == 'module_5' %}{{ url_for('module_5.fill_step', step='host_space_object_details', application_id=application.id) }}{% elif module == 'module_6' %}{{ url_for('module_6.fill_step', step='itu_filing_details', application_id=application.id) }}{% elif module == 'module_7' %}{{ url_for('module_7.fill_step', step='previous_authorization', application_id=application.id) }}{% elif module == 'module_8' %}{{ url_for('module_8.fill_step', step='renewal_and_extension_details', application_id=application.id) }}{% elif module == 'module_9' %}{{ url_for('module_9.fill_step', step='general_info', application_id=application.id) }}{% elif module == 'module_10' %}{{ url_for('module_10.fill_step', step='general_info', application_id=application.id) }}{% endif %}" class="{% if module == 'module_1' %}text-blue-600{% elif module == 'module_2' %}text-green-600{% elif module == 'module_3' %}text-purple-600{% elif module == 'module_4' %}text-indigo-600{% elif module == 'module_5' %}text-pink-600{% elif module == 'module_6' %}text-yellow-600{% elif module == 'module_7' %}text-orange-600{% elif module == 'module_8' %}text-teal-600{% elif module == 'module_9' %}text-cyan-600{% elif module == 'module_10' %}text-red-600{% endif %} hover:underline text-sm font-semibold">
                            View / Edit
                        </a>
                        {% else %}
                        <span class="text-gray-500 text-sm font-semibold cursor-not-allowed" title="Editing is disabled because the application is {{ application.status }}">
                            View / Edit (Disabled)
                        </span>
                        {% endif %}
                        {% if application.status in ['Under Review', 'Pending Secondary Approval', 'Pending Director Approval', 'Rejected', 'Approved'] %}
                        {% if application.id %}
                            <a href="{{ url_for('chat.chat_view', application_id=application.id) }}" class="py-1 px-3 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 text-sm font-semibold">Chat</a>
                        {% else %}
                            <span class="py-1 px-3 bg-gray-500 text-white rounded-lg text-sm font-semibold">Chat Unavailable</span>
                        {% endif %}
                        {% endif %}
                    </div>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="text-gray-500 text-center">No {{ MODULE_NAME_MAPPING[module] }} applications found.</p>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const tabLinks = document.querySelectorAll(".tab-link");
        const tabContents = document.querySelectorAll(".tab-content");

        tabLinks.forEach(button => {
            button.addEventListener("click", () => {
                const tabId = button.getAttribute("data-tab");
                tabLinks.forEach(btn => {
                    btn.classList.remove("text-blue-600", "bg-blue-100", "border-blue-600", "font-bold");
                    btn.classList.add("border-transparent");
                });
                tabContents.forEach(content => content.classList.add("hidden"));
                button.classList.add("text-blue-600", "bg-blue-100", "border-blue-600", "font-bold");
                document.getElementById(tabId).classList.remove("hidden");
            });
        });

        document.querySelectorAll("[id^='start-application-link-']").forEach(link => {
            link.addEventListener("click", function(event) {
                event.preventDefault();
                const module = this.getAttribute("data-module");
                fetch(`{{ url_for('applicant.start_application') }}?module=${module}`, {
                    method: "GET",
                    headers: { "Content-Type": "application/json" }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire({
                            title: "Success!",
                            text: `New ${module.replace('_', ' ')} application started successfully!`,
                            icon: "success",
                            confirmButtonColor: "#3085d6",
                            confirmButtonText: "Proceed"
                        }).then(() => {
                            window.location.href = data.redirect_url;
                        });
                    } else {
                        Swal.fire({
                            title: "Warning!",
                            text: data.message || "Please complete Module 1 before starting this module.",
                            icon: "warning",
                            confirmButtonColor: "#d33",
                            confirmButtonText: "Go to Module 1"
                        }).then(() => {
                            window.location.href = data.redirect_url;
                        });
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    Swal.fire({
                        title: "Error!",
                        text: "Something went wrong. Please try again later.",
                        icon: "error",
                        confirmButtonColor: "#d33",
                        confirmButtonText: "Close"
                    });
                });
            });
        });
    });
</script>
{% endblock %}